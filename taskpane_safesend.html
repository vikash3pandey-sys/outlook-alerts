<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>PayTM Safe Send</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto; background: #f5f5f5; padding: 16px; }
        .header { font-size: 16px; font-weight: 600; color: #333; padding: 12px; background: white; border-radius: 8px; border-left: 4px solid #ff6b6b; margin-bottom: 16px; }
        .content { background: white; border-radius: 8px; padding: 20px; text-align: center; color: #666; }
        .emoji { font-size: 48px; margin-bottom: 16px; }
        .text { font-size: 14px; line-height: 1.6; color: #999; }
        .warning-box { background: #ffebee; border: 1px solid #ffcdd2; border-radius: 6px; padding: 12px; margin-top: 16px; color: #c62828; font-size: 12px; display: none; }
        .warning-box.show { display: block; }
        .external-list { margin-top: 12px; text-align: left; }
        .recipient { padding: 8px; background: #fff3e0; border-radius: 4px; margin: 4px 0; font-size: 12px; }
    </style>
</head>
<body>
    <div class="header">⚠️ PayTM Safe Send</div>
    
    <div class="content">
        <div class="emoji">✉️</div>
        <div class="text">Add recipients to check if they are from paytm.com domain</div>
    </div>
    
    <div class="warning-box" id="warningBox">
        <div style="font-weight: bold; margin-bottom: 8px;">⚠️ External Recipients Detected:</div>
        <div class="external-list" id="externalList"></div>
    </div>

    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <script>
        console.log('[SafeSend] Page loaded');
        
        try {
            // Simple initialization
            Office.onReady(function(info) {
                console.log('[SafeSend] Office ready:', info.host);
                
                if (info.host === Office.HostType.Outlook) {
                    startMonitoring();
                }
            });
        } catch (e) {
            console.log('[SafeSend] Init error:', e.message);
        }

        function startMonitoring() {
            console.log('[SafeSend] Starting monitor');
            
            setInterval(function() {
                try {
                    checkRecipients();
                } catch (err) {
                    console.log('[SafeSend] Check error:', err.message);
                }
            }, 1000);
        }

        function checkRecipients() {
            try {
                const item = Office.context.mailbox.item;
                if (!item) return;

                // Get recipients synchronously
                const toField = item.to;
                const ccField = item.cc;
                const bccField = item.bcc;

                // Try to get TO recipients
                if (toField) {
                    toField.getAsync(function(result) {
                        try {
                            if (result.status === Office.AsyncResultStatus.Succeeded) {
                                const recipients = result.value || [];
                                processRecipients(recipients);
                            }
                        } catch (e) {
                            console.log('[SafeSend] TO error:', e.message);
                        }
                    });
                }
            } catch (err) {
                console.log('[SafeSend] checkRecipients error:', err.message);
            }
        }

        function processRecipients(recipients) {
            const external = [];

            for (let i = 0; i < recipients.length; i++) {
                try {
                    const email = recipients[i].emailAddress.toLowerCase();
                    const domain = email.split('@')[1];

                    if (domain && domain !== 'paytm.com') {
                        external.push(email);
                    }
                } catch (e) {
                    // Skip errors
                }
            }

            // Show warning if external found
            const warningBox = document.getElementById('warningBox');
            const externalList = document.getElementById('externalList');

            if (external.length > 0) {
                let html = '';
                for (let i = 0; i < external.length; i++) {
                    const domain = external[i].split('@')[1];
                    html += '<div class="recipient">⚠️ ' + external[i] + ' (' + domain + ')</div>';
                }
                externalList.innerHTML = html;
                warningBox.classList.add('show');
                console.log('[SafeSend] Warning shown for:', external);
            } else {
                warningBox.classList.remove('show');
            }
        }
    </script>
</body>
</html>
