<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>PayTM Safe Send - Send Handler</title>
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
</head>
<body>
    <script>
        // PayTM Safe Send - ItemSend Event Handler
        // This function is called BEFORE email is sent to check recipients
        
        const TRUSTED_DOMAIN = 'paytm.com';
        
        /**
         * Main function: checkExternalRecipients
         * Called when user clicks Send in Outlook
         * @param {Object} event - ItemSend event object
         */
        function checkExternalRecipients(event) {
            console.log('[PayTM SafeSend] checkExternalRecipients triggered');
            
            try {
                const item = event.item;
                
                // Get TO recipients
                item.to.getAsync(function(toResult) {
                    processResult(toResult, event, 'TO');
                });
                
            } catch (err) {
                console.log('[PayTM SafeSend] Error: ' + err.message);
                // Allow send on error to not break normal workflow
                event.completed({ allowEvent: true });
            }
        }
        
        /**
         * Process recipient results
         */
        function processResult(result, event, fieldName) {
            try {
                if (result.status !== Office.AsyncResultStatus.Succeeded) {
                    console.log('[PayTM SafeSend] ' + fieldName + ' failed');
                    event.completed({ allowEvent: true });
                    return;
                }
                
                const recipients = result.value || [];
                const externalRecipients = [];
                
                // Check each recipient
                for (let i = 0; i < recipients.length; i++) {
                    try {
                        const email = (recipients[i].emailAddress || '').toLowerCase().trim();
                        const domain = email.split('@')[1];
                        
                        // Not trusted domain?
                        if (domain && domain !== TRUSTED_DOMAIN) {
                            externalRecipients.push(email);
                            console.log('[PayTM SafeSend] EXTERNAL: ' + email);
                        } else {
                            console.log('[PayTM SafeSend] SAFE: ' + email);
                        }
                    } catch (e) {
                        console.log('[PayTM SafeSend] Error parsing recipient: ' + e.message);
                    }
                }
                
                // External recipients found - show warning
                if (externalRecipients.length > 0) {
                    console.log('[PayTM SafeSend] Found ' + externalRecipients.length + ' external recipients');
                    
                    // Create warning message
                    let message = '⚠️ WARNING: External Recipients Detected\n\n';
                    message += 'You are sending to recipients outside PayTM domain:\n\n';
                    for (let i = 0; i < externalRecipients.length; i++) {
                        message += '• ' + externalRecipients[i] + '\n';
                    }
                    message += '\nDo you want to continue sending?';
                    
                    // Show dialog - user confirms or cancels
                    if (confirm(message)) {
                        console.log('[PayTM SafeSend] User confirmed - allowing send');
                        event.completed({ allowEvent: true });
                    } else {
                        console.log('[PayTM SafeSend] User cancelled - blocking send');
                        event.completed({ allowEvent: false });
                    }
                } else {
                    // All recipients are safe
                    console.log('[PayTM SafeSend] All recipients safe - allowing send');
                    event.completed({ allowEvent: true });
                }
                
            } catch (err) {
                console.log('[PayTM SafeSend] Process error: ' + err.message);
                event.completed({ allowEvent: true });
            }
        }
    </script>
</body>
</html>
