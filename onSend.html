<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>PayTM Safe Send - Send Handler</title>
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
</head>
<body style="display:none;">
    <script>
        // Make function available globally
        window.checkExternalRecipients = function(event) {
            console.log('[PayTM SafeSend] checkExternalRecipients called');
            
            try {
                const item = event.item;
                
                item.to.getAsync(function(toResult) {
                    try {
                        if (toResult.status !== Office.AsyncResultStatus.Succeeded) {
                            console.log('[PayTM SafeSend] Failed to get recipients');
                            event.completed({ allowEvent: true });
                            return;
                        }
                        
                        const recipients = toResult.value || [];
                        const externalRecipients = [];
                        
                        // Check each recipient
                        for (let i = 0; i < recipients.length; i++) {
                            const email = (recipients[i].emailAddress || '').toLowerCase().trim();
                            const domain = email.split('@')[1];
                            
                            if (domain && domain !== 'paytm.com') {
                                externalRecipients.push(email);
                            }
                        }
                        
                        // If external found, show warning
                        if (externalRecipients.length > 0) {
                            console.log('[PayTM SafeSend] External recipients: ' + externalRecipients.join(', '));
                            
                            let msg = '⚠️ WARNING: External Recipients\n\n';
                            msg += 'You are sending to:\n\n';
                            for (let i = 0; i < externalRecipients.length; i++) {
                                msg += '• ' + externalRecipients[i] + '\n';
                            }
                            msg += '\nVerify these are intended recipients.';
                            
                            // Show alert and ALLOW send
                            alert(msg);
                            event.completed({ allowEvent: true });
                        } else {
                            // All safe
                            console.log('[PayTM SafeSend] All recipients safe');
                            event.completed({ allowEvent: true });
                        }
                        
                    } catch (e) {
                        console.log('[PayTM SafeSend] Error in callback: ' + e.message);
                        event.completed({ allowEvent: true });
                    }
                });
                
            } catch (err) {
                console.log('[PayTM SafeSend] Error: ' + err.message);
                event.completed({ allowEvent: true });
            }
        };
        
        console.log('[PayTM SafeSend] Function ready');
    </script>
</body>
</html>
