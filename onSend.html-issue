<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
</head>
<body>
</body>
</html>

<script>
// Function MUST be declared at global scope - NOT inside any other function
function checkExternalRecipients(event) {
    alert('✓ FUNCTION CALLED - STEP 1');
    
    try {
        var mailItem = event.item;
        alert('✓ Got mailItem - STEP 2');
        
        mailItem.to.getAsync(function(asyncResult) {
            alert('✓ Got recipients - STEP 3');
            
            if (asyncResult.status === Office.AsyncResultStatus.Succeeded) {
                var recipients = asyncResult.value;
                alert('✓ Recipients count: ' + recipients.length + ' - STEP 4');
                
                var hasExternal = false;
                var externalList = [];
                
                for (var i = 0; i < recipients.length; i++) {
                    var emailAddress = recipients[i].emailAddress.toLowerCase();
                    var domain = emailAddress.split('@')[1];
                    
                    alert('Checking: ' + emailAddress + ' | Domain: ' + domain);
                    
                    if (domain !== 'paytm.com' && domain !== undefined && domain !== '') {
                        hasExternal = true;
                        externalList.push(emailAddress);
                        alert('⚠️ EXTERNAL FOUND: ' + emailAddress);
                    }
                }
                
                alert('✓ hasExternal: ' + hasExternal + ' - STEP 5');
                
                if (hasExternal) {
                    var msg = '⚠️ WARNING: EXTERNAL RECIPIENTS\n\n';
                    msg += 'Sending to:\n';
                    for (var j = 0; j < externalList.length; j++) {
                        msg += externalList[j] + '\n';
                    }
                    msg += '\nVerify and continue?';
                    alert(msg);
                } else {
                    alert('✓ All recipients are paytm.com');
                }
            }
            
            event.completed({ allowEvent: true });
        });
        
    } catch (err) {
        alert('ERROR: ' + err.message);
        event.completed({ allowEvent: true });
    }
}

// Make sure function is global
window.checkExternalRecipients = checkExternalRecipients;
alert('onSend.html loaded - function registered');
</script>
